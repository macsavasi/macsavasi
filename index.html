<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flag Battle Royale - Fast & Furious Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto:wght@400;900&display=swap" rel="stylesheet">
    <style>
        /* --- Tƒ∞POGRAFƒ∞ (Bƒ∞RAZ DAHA K√ú√á√úLT√úLD√ú) --- */
        :root {
            --fs-xs: 1.3vh;
            --fs-sm: 1.8vh; /* Standart metin k√º√ß√ºld√º */
            --fs-md: 2.5vh; /* Ba≈ülƒ±klar k√º√ß√ºld√º */
            --fs-lg: 3.5vh; /* Ana ba≈ülƒ±k */
            --fs-xl: 5.5vh; /* Saya√ß */
        }

        body {
            margin: 0; overflow: hidden; background-color: #050505;
            font-family: 'Roboto', sans-serif; touch-action: none; user-select: none;
            transition: background-color 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* Arka Plan */
        #bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(26,11,46,0.8) 0%, #000000 90%);
            z-index: -1; pointer-events: none;
        }

        canvas { display: block; width: 100vw; height: 100vh; }

        .hud-panel {
            position: absolute; z-index: 15; pointer-events: none;
            display: flex; align-items: center; gap: 10px;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.9);
        }

        /* --- √úST PANELLER --- */
        #radio-panel {
            top: 50px; right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 16px; border-radius: 50px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #00ff9d; font-size: var(--fs-sm);
            display: flex; align-items: center; gap: 10px;
            font-weight: bold;
        }
        
        #live-panel { top: 50px; left: 20px; color: white; font-weight: 900; font-size: var(--fs-md); }
        #round-panel { top: 100px; left: 20px; font-family: 'Black Ops One'; font-size: var(--fs-md); color: #00ffff; opacity: 1; }
        
        /* --- ALT PANELLER --- */
        #stats-panel { bottom: 38%; left: 50%; transform: translateX(-50%); text-align: center; }
        .counter-box { font-family: 'Black Ops One'; font-size: var(--fs-xl); color: #fff; text-shadow: 0 0 30px rgba(0,255,255,0.8); line-height: 1; }
        .counter-label { font-size: var(--fs-sm); color: #fff; text-transform: uppercase; letter-spacing: 3px; font-weight: bold; }

        #last-wins { bottom: 32%; left: 20px; flex-direction: column; align-items: flex-start; font-size: var(--fs-sm); color: #fff; opacity: 1; }
        .lw-title { font-weight: 900; letter-spacing: 1px; margin-bottom: 6px; color: #ffd700; font-size: var(--fs-sm); }
        #win-stats { bottom: 32%; right: 20px; font-size: var(--fs-sm); color: #fff; max-width: 250px; text-align: right; display: block; font-weight: bold; }

        /* Ba≈ülƒ±klar */
        .bottom-hook { bottom: 15%; font-size: var(--fs-md); font-weight: 900; background: rgba(0,0,0,0.6); padding: 15px 0; color: #fff; width: 100%; letter-spacing: 2px; }
        .top-hook { top: 15%; font-family: 'Black Ops One'; font-size: var(--fs-lg); color: #00ffff; letter-spacing: 3px; text-shadow: 0 0 30px #00ffff; }

        /* G√∂rsel √ñƒüeler */
        .eq-bar { width: 5px; background: #00ff9d; animation: eq 0.8s infinite ease-in-out; }
        .eq-1 { height: 15px; } .eq-2 { height: 25px; } .eq-3 { height: 12px; }
        
        /* Sudden Death Renkleri */
        body.sudden .eq-bar { background: #ff4444; } 
        body.sudden #radio-panel { border-color: #ff4444; color: #ff4444; } 
        body.sudden .top-hook { color: #ff4444; text-shadow: 0 0 50px #ff0000; }
        
        .live-badge { background: #ff0000; padding: 4px 12px; border-radius: 6px; font-size: var(--fs-sm); margin-right: 10px; }
        #clock { font-family: 'Black Ops One'; }
        .hook-text { position: absolute; width: 100%; text-align: center; text-transform: uppercase; color: #fff; pointer-events: none; z-index: 10; }
        
        #winnerOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); z-index: 20; backdrop-filter: blur(10px); }
        #w-flag { width: 250px; height: 250px; border-radius: 50%; border: 10px solid #FFD700; box-shadow: 0 0 100px #FFD700; object-fit: cover; margin-bottom: 30px; }
        #w-title { font-family: 'Black Ops One'; font-size: 8vh; color: #FFD700; margin: 0; }
        #w-name { font-size: 5vh; color: #fff; text-transform: uppercase; font-weight: bold; margin-top: 10px; }
        #timer { margin-top: 40px; font-size: 3vh; color: #888; }
        
        #last-win-list { list-style: none; padding: 0; margin: 0; } 
        #last-win-list li { line-height: 1.5; border-bottom: 2px solid rgba(255,255,255,0.2); padding: 5px 0; }
        #last-win-list img { width: 20px; height: auto; margin-right: 8px; vertical-align: middle; }

        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes livePulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes eq { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(0.5); } }
    </style>
</head>
<body>

    <div id="bg"></div>
    
    <div id="live-panel" class="hud-panel">
        <span class="live-badge">‚óè LIVE</span>
        <span id="clock">00:00:00</span>
    </div>
    <div id="round-panel" class="hud-panel">
        ROUND <span id="round-number">1</span>
    </div>

    <div id="radio-panel" class="hud-panel">
        <div style="display:flex; gap:2px; align-items:flex-end; height:15px;">
            <div class="eq-bar eq-1"></div>
            <div class="eq-bar eq-2"></div>
            <div class="eq-bar eq-3"></div>
        </div>
        <span>NightRide FM ‚Ä¢ Synthwave</span>
    </div>

    <div id="stats-panel" class="hud-panel">
        <div class="counter-box" id="alive-counter">00</div>
        <div class="counter-label">ALIVE / <span id="total-counter">00</span></div>
    </div>

    <div id="last-wins" class="hud-panel">
        <div class="lw-title">LAST WINS</div>
        <ul id="last-win-list"></ul>
    </div>

    <div id="win-stats" class="hud-panel"></div>

    <div class="hook-text top-hook">FLAG BATTLE<br>ROYALE</div>
    <div class="hook-text bottom-hook">LAST ONE STANDING WINS! üèÜ</div>

    <div id="winnerOverlay">
        <div id="w-title">WINNER</div>
        <img id="w-flag" src="" alt="">
        <div id="w-name">COUNTRY</div>
        <div id="timer">NEXT ROUND SOON...</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <audio id="bgMusic" loop preload="auto" crossorigin="anonymous">
        <source src="https://stream.nightride.fm/nightride.mp3" type="audio/mpeg">
    </audio>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // UI Elements
    const winnerOverlay = document.getElementById('winnerOverlay');
    const wFlag = document.getElementById('w-flag');
    const wName = document.getElementById('w-name');
    const timerText = document.getElementById('timer');
    const aliveCounter = document.getElementById('alive-counter');
    const totalCounter = document.getElementById('total-counter');
    const clockEl = document.getElementById('clock');
    const bgMusic = document.getElementById('bgMusic');
    const roundEl = document.getElementById('round-number');
    const lastWinList = document.getElementById('last-win-list');
    const winStatsEl = document.getElementById('win-stats');

    // Game State
    let roundCount = 1;
    let suddenDeath = false;
    let gameStartTime = 0;
    
    // Hot Streak Logic
    let lastWinners = []; 
    let previousWinnerName = "";
    let currentStreak = 0;
    
    const winStats = {};

    const COUNTRIES = [
        {c:'tr',n:'Turkey', h:'#E30A17'}, {c:'us',n:'USA', h:'#3C3B6E'}, {c:'de',n:'Germany', h:'#FFCE00'}, 
        {c:'br',n:'Brazil', h:'#009c3b'}, {c:'fr',n:'France', h:'#0055A4'}, {c:'gb',n:'UK', h:'#C8102E'}, 
        {c:'it',n:'Italy', h:'#008C45'}, {c:'ru',n:'Russia', h:'#DA291C'}, {c:'cn',n:'China', h:'#EE1C25'}, 
        {c:'jp',n:'Japan', h:'#BC002D'}, {c:'kr',n:'S. Korea', h:'#003478'}, {c:'in',n:'India', h:'#FF9933'}, 
        {c:'ca',n:'Canada', h:'#FF0000'}, {c:'au',n:'Australia', h:'#00008B'}, {c:'es',n:'Spain', h:'#AA151B'},
        {c:'mx',n:'Mexico', h:'#006847'}, {c:'id',n:'Indonesia', h:'#FF0000'}, {c:'sa',n:'Saudi Arabia', h:'#006C35'}, 
        {c:'ar',n:'Argentina', h:'#74ACDF'}, {c:'ng',n:'Nigeria', h:'#008751'}, {c:'eg',n:'Egypt', h:'#C09300'}, 
        {c:'pk',n:'Pakistan', h:'#115740'}, {c:'vn',n:'Vietnam', h:'#DA251D'}, {c:'ph',n:'Philippines', h:'#0038A8'}, 
        {c:'th',n:'Thailand', h:'#A51931'}, {c:'ir',n:'Iran', h:'#DA0000'}, {c:'nl',n:'Netherlands', h:'#AE1C28'}, 
        {c:'pl',n:'Poland', h:'#DC143C'}, {c:'ua',n:'Ukraine', h:'#0057B8'}, {c:'co',n:'Colombia', h:'#FCD116'}, 
        {c:'se',n:'Sweden', h:'#006AA7'}, {c:'az',n:'Azerbaijan', h:'#00B5E2'}, {c:'pt',n:'Portugal', h:'#046A38'},
        {c:'gr',n:'Greece', h:'#0D5EAF'}, {c:'be',n:'Belgium', h:'#000000'}, {c:'ch',n:'Switzerland', h:'#D52B1E'}, 
        {c:'at',n:'Austria', h:'#ED2939'}, {c:'hu',n:'Hungary', h:'#477050'}, {c:'no',n:'Norway', h:'#BA0C2F'}, 
        {c:'dk',n:'Denmark', h:'#C60C30'}, {c:'fi',n:'Finland', h:'#003580'}, {c:'ie',n:'Ireland', h:'#169B62'}, 
        {c:'nz',n:'New Zealand', h:'#00247D'}, {c:'sg',n:'Singapore', h:'#EF3340'}, {c:'my',n:'Malaysia', h:'#010066'}, 
        {c:'cl',n:'Chile', h:'#D52B1E'}, {c:'pe',n:'Peru', h:'#D91023'}, {c:'ve',n:'Venezuela', h:'#FCD116'},
        {c:'ec',n:'Ecuador', h:'#FFDD00'}, {c:'ma',n:'Morocco', h:'#C1272D'}, {c:'dz',n:'Algeria', h:'#006633'}, 
        {c:'kz',n:'Kazakhstan', h:'#00AFCA'}, {c:'il',n:'Israel', h:'#0038B8'}, {c:'qa',n:'Qatar', h:'#8D1B3D'}, 
        {c:'ae',n:'UAE', h:'#00732F'}, {c:'hr',n:'Croatia', h:'#FF0000'}, {c:'rs',n:'Serbia', h:'#C6363C'}, 
        {c:'ba',n:'Bosnia', h:'#002395'}
    ];

    function updateClock() {
        const now = new Date();
        clockEl.innerText = now.toLocaleTimeString('tr-TR', { hour12: false });
    }
    setInterval(updateClock, 1000); updateClock();

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    function initAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        bgMusic.volume = 0.3; 
        bgMusic.play().catch(e => console.log("Otomatik oynatma engellendi."));
    }
    document.addEventListener('click', () => { if (audioCtx) audioCtx.resume(); if (bgMusic.paused) bgMusic.play(); }, { once: true });

    function playSound(type) {
        if (!audioCtx || audioCtx.state === 'suspended') return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if (type === 'bounce') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(50, now+0.1);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
            osc.start(now); osc.stop(now+0.1);
        } else if (type === 'eliminate') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(300, now); osc.frequency.exponentialRampToValueAtTime(50, now+0.3);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.3);
            osc.start(now); osc.stop(now+0.3);
        }
    }

    let WIDTH, HEIGHT, CX, CY, ARENA_RADIUS;

    function resize() {
        const dpr = window.devicePixelRatio || 1;
        WIDTH = window.innerWidth;
        HEIGHT = window.innerHeight;
        canvas.width = WIDTH * dpr;
        canvas.height = HEIGHT * dpr;
        canvas.style.width = WIDTH + "px";
        canvas.style.height = HEIGHT + "px";
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        CX = WIDTH / 2;
        CY = HEIGHT * 0.45; 
        ARENA_RADIUS = (WIDTH / 2) * 0.90; 
    }
    resize(); window.addEventListener('resize', resize);

    // --- Fƒ∞Zƒ∞K AYARLARI ---
    const BALL_RADIUS = 32; 
    const GAP_SIZE = Math.PI / 4.5; 
    const GRAVITY = 0.25; 
    const FRICTION_ARENA = 1.0; 
    const FRICTION_AIR = 0.98;
    let arenaRotation = 0; 
    const ROTATION_SPEED = 0.025; 
    let screenShake = 0;

    let balls = []; let particles = []; let animationId; let isGameOver = false; let gameRunning = true; 

    class Particle {
        constructor(x, y, color) {
            this.x=x; this.y=y; this.color=color; this.size=Math.random()*4+2; 
            this.vx=(Math.random()-0.5)*6; this.vy=(Math.random()-0.5)*6; this.life=1.0;
        }
        update() { this.x+=this.vx; this.y+=this.vy; this.vy+=0.1; this.life-=0.02; }
        draw(ctx) { ctx.globalAlpha=this.life; ctx.fillStyle=this.color; ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1.0; }
    }

    class Ball {
        constructor(data) {
            this.code=data.c; this.name=data.n; this.colorHex=data.h; this.r=BALL_RADIUS;
            const a = Math.random()*Math.PI*2; const d = Math.random()*(ARENA_RADIUS*0.6);
            this.x=CX+Math.cos(a)*d; this.y=CY+Math.sin(a)*d;
            this.vx=(Math.random()-0.5)*12; this.vy=(Math.random()-0.5)*12;
            this.img=new Image(); this.img.src=`https://flagcdn.com/w80/${this.code}.png`;
            this.state='ARENA'; this.rotation=0; this.rotSpeed=(Math.random()-0.5)*0.2;
        }
        update() {
            if(this.state !== 'GROUNDED' && this.state !== 'FALLING') this.rotation+=this.rotSpeed;

            if (this.state === 'ARENA') {
                this.x+=this.vx; this.y+=this.vy; this.vx*=FRICTION_ARENA; this.vy*=FRICTION_ARENA;
                
                // MINIMUM HIZ KONTROL√ú (Durmayƒ± √∂nler)
                const speed = Math.hypot(this.vx, this.vy);
                if (speed < 4) { // Eƒüer 4 birimden yava≈üsa hƒ±zlandƒ±r
                    this.vx *= 1.05;
                    this.vy *= 1.05;
                }
                // Maksimum Hƒ±z Limiti (√áok u√ßmasƒ±n)
                if (speed > 40) {
                    this.vx *= 0.9;
                    this.vy *= 0.9;
                }
                
                const dist = Math.hypot(this.x-CX, this.y-CY);
                if (dist + this.r >= ARENA_RADIUS) {
                    let ang = Math.atan2(this.y-CY, this.x-CX); if(ang<0) ang+=Math.PI*2;
                    let gs = (arenaRotation%(Math.PI*2)); let ge = (gs+GAP_SIZE)%(Math.PI*2);
                    let inGap = (gs<ge) ? (ang>=gs && ang<=ge) : (ang>=gs || ang<=ge);
                    
                    if (inGap) {
                        this.state = 'FALLING'; screenShake = 5; playSound('eliminate');
                        createParticles(this.x, this.y, '#fff', 12); 
                    } else {
                        const overlap = dist + this.r - ARENA_RADIUS;
                        const nx = (this.x-CX)/dist; const ny = (this.y-CY)/dist;
                        this.x -= nx*overlap; this.y -= ny*overlap;
                        const dot = this.vx*nx + this.vy*ny;
                        this.vx = (this.vx - 2*dot*nx)*1.0; this.vy = (this.vy - 2*dot*ny)*1.0;
                        playSound('bounce');
                    }
                }
            } 
            else if (this.state === 'FALLING') {
                this.vy += GRAVITY; this.vx *= FRICTION_AIR;
                this.x += this.vx; this.y += this.vy;
                this.rotation = Math.atan2(this.vy, this.vx * 0.5) + Math.PI/2;
                if (this.x-this.r<0 || this.x+this.r>WIDTH) { this.vx*=-0.7; this.x=Math.max(this.r, Math.min(WIDTH-this.r,this.x)); }
                if (this.y+this.r >= HEIGHT-10) {
                    this.y=HEIGHT-10-this.r; this.vy*=-0.5; this.vx*=0.9;
                    if(Math.abs(this.vy)<1 && Math.abs(this.vx)<0.5) { this.state='GROUNDED'; createParticles(this.x,this.y+this.r,'#aaa',3); }
                }
            }
            else if (this.state === 'GROUNDED') {
                this.vx*=0.9; this.vy+=GRAVITY; this.x+=this.vx; this.y+=this.vy;
                this.rotation = 0;
                if(this.y+this.r>=HEIGHT-10) { this.y=HEIGHT-10-this.r; this.vy=0; }
                if(this.x-this.r<0) this.x=this.r; if(this.x+this.r>WIDTH) this.x=WIDTH-this.r;
            }
        }
        draw(ctx) {
            ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rotation);
            ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.clip();
            ctx.drawImage(this.img, -this.r, -this.r, this.r*2, this.r*2); ctx.restore();
            ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2);
            ctx.strokeStyle = this.state==='ARENA' ? '#fff' : '#ff0055'; ctx.lineWidth=3; ctx.stroke();
            if(this.state==='ARENA') { ctx.shadowBlur=15; ctx.shadowColor='#fff'; ctx.stroke(); ctx.shadowBlur=0; }
        }
    }

    function createParticles(x, y, color, count) { for(let i=0; i<count; i++) particles.push(new Particle(x,y,color)); }
    function resolveCollisions() {
        for(let i=0; i<balls.length; i++) {
            for(let j=i+1; j<balls.length; j++) {
                let b1=balls[i], b2=balls[j];
                let dx=b2.x-b1.x, dy=b2.y-b1.y, dist=Math.hypot(dx,dy);
                if(dist < b1.r+b2.r) {
                    let ov=(b1.r+b2.r-dist)/2; let nx=dx/dist, ny=dy/dist;
                    b1.x-=nx*ov; b1.y-=ny*ov; b2.x+=nx*ov; b2.y+=ny*ov;
                    let rvx=b2.vx-b1.vx, rvy=b2.vy-b1.vy;
                    let vn=rvx*nx + rvy*ny; if(vn>0) continue;
                    let im=-(1+1.0)*vn/2; 
                    let damping = (b1.state==='ARENA' && b2.state==='ARENA') ? 1.0 : 0.8;
                    b1.vx-=im*nx*damping; b1.vy-=im*ny*damping; b2.vx+=im*nx*damping; b2.vy+=im*ny*damping;
                    if(Math.abs(vn)>10 && b1.state==='ARENA') { createParticles((b1.x+b2.x)/2,(b1.y+b2.y)/2,'#ffff00',2); playSound('bounce'); }
                }
            }
        }
    }

    function drawArena() {
        arenaRotation += ROTATION_SPEED;
        ctx.save();
        let jitterX = 0, jitterY = 0;
        if (suddenDeath) { jitterX = (Math.random() - 0.5) * 6; jitterY = (Math.random() - 0.5) * 6; }
        let strokeCol = '#00ffff'; let shadowCol = '#00ffff';
        if (document.body.classList.contains('warning')) { strokeCol = '#ffff00'; shadowCol = '#ffff00'; }
        if (document.body.classList.contains('sudden')) { strokeCol = '#ff0000'; shadowCol = '#ff0000'; }
        
        ctx.shadowBlur = 40; ctx.shadowColor = shadowCol; ctx.strokeStyle = strokeCol;
        ctx.lineWidth = Math.max(16, HEIGHT * 0.02); 
        ctx.lineCap = 'round';
        
        ctx.beginPath();
        ctx.arc(CX + jitterX, CY + jitterY, ARENA_RADIUS, arenaRotation + GAP_SIZE, arenaRotation + Math.PI*2);
        ctx.stroke();
        ctx.shadowBlur = 0; 
        ctx.strokeStyle = 'rgba(255, 0, 50, 0.4)'; ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.arc(CX, CY, ARENA_RADIUS, arenaRotation, arenaRotation + GAP_SIZE);
        ctx.stroke();
        ctx.restore();
    }

    function animate() {
        if (!gameRunning) return;
        const elapsed = (performance.now() - gameStartTime) / 1000;

        // UYARI: 21. saniyeden 23. saniyeye kadar sarƒ±
        if (!suddenDeath && elapsed > 21 && elapsed < 23) { document.body.classList.add('warning'); } 
        else { document.body.classList.remove('warning'); }

        // --- HIZLANDIRMA (10. saniyeden sonra hafif√ße artƒ±r) ---
        if (elapsed > 10 && !suddenDeath) {
            balls.forEach(b => {
                if (b.state === 'ARENA') {
                    b.vx *= 1.0005; 
                    b.vy *= 1.0005;
                }
            });
        }

        // --- IMPLODE (VAKUM) ETKƒ∞Sƒ∞ (21.5 - 22.8 sn arasƒ±) ---
        if (!suddenDeath && elapsed > 21.5 && elapsed < 22.8) {
             balls.forEach(b => {
                 if(b.state === 'ARENA') {
                     let dx = CX - b.x;
                     let dy = CY - b.y;
                     b.vx += dx * 0.06; // Merkeze √ßek
                     b.vy += dy * 0.06;
                 }
             });
        }

        // --- EXPLOSION & SUDDEN DEATH (23. sn) ---
        if (!suddenDeath && elapsed >= 23) {
            suddenDeath = true; 
            ARENA_RADIUS *= 0.85; 
            
            // PATLAMA EFEKTƒ∞: Merkezden dƒ±≈üarƒ±ya doƒüru fƒ±rlat
            balls.forEach(b => { 
                if (b.state === 'ARENA') {
                    // Topun merkeze g√∂re a√ßƒ±sƒ±nƒ± bul ve tam tersi y√∂ne fƒ±rlat
                    let angle = Math.atan2(b.y - CY, b.x - CX); 
                    let force = 40; // √áok y√ºksek hƒ±z (Explosion)
                    b.vx = Math.cos(angle) * force;
                    b.vy = Math.sin(angle) * force;
                }
            });
            bgMusic.volume = 0.45; document.body.classList.add('sudden');
        }
        
        // SUDDEN DEATH S√úRESƒ∞NCE S√úREKLƒ∞ HIZLANDIRMA
        if (suddenDeath) {
             balls.forEach(b => { 
                 if (b.state === 'ARENA') {
                     b.vx *= 1.002; 
                     b.vy *= 1.002;
                 }
             });
        }

        ctx.save();
        if (screenShake > 0) {
            let dx = (Math.random()-0.5)*screenShake; let dy = (Math.random()-0.5)*screenShake;
            ctx.translate(dx, dy); screenShake*=0.9; if(screenShake<0.5) screenShake=0;
        }

        ctx.clearRect(0, 0, WIDTH, HEIGHT); 
        drawArena();

        let activeCount = 0; let survivor = null;
        balls.forEach(ball => {
            ball.update(); ball.draw(ctx);
            if (ball.state === 'ARENA') { activeCount++; survivor = ball; }
        });
        
        aliveCounter.innerText = activeCount < 10 ? '0' + activeCount : activeCount;
        for(let i=particles.length-1; i>=0; i--) { particles[i].update(); particles[i].draw(ctx); if(particles[i].life<=0) particles.splice(i,1); }

        resolveCollisions();
        ctx.restore(); 

        if (activeCount <= 1 && survivor && !isGameOver) { endGame(survivor); } 
        else if (activeCount === 0 && !isGameOver) { resetGame(); } 
        else { animationId = requestAnimationFrame(animate); }
    }

    function endGame(winner) {
        isGameOver = true; cancelAnimationFrame(animationId); roundCount++;
        document.body.style.backgroundColor = winner.colorHex || '#333';
        let streakIcon = "";
        if (winner.name === previousWinnerName) { currentStreak++; if (currentStreak > 1) streakIcon = " üî•"; } 
        else { currentStreak = 1; }
        previousWinnerName = winner.name;

        lastWinners.unshift({name: winner.name, img: winner.img.src, streak: streakIcon});
        if (lastWinners.length > 3) lastWinners.pop();
        lastWinList.innerHTML = '';
        lastWinners.forEach(w => {
            const li = document.createElement('li');
            li.innerHTML = `<img src="${w.img}" style="width:20px; vertical-align:middle; margin-right:4px;"> ${w.name} ${w.streak}`;
            lastWinList.appendChild(li);
        });

        winStats[winner.name] = (winStats[winner.name] || 0) + 1;
        winStatsEl.innerHTML = Object.entries(winStats).sort((a,b) => b[1]-a[1]).slice(0,5).map(([n,c]) => `${n}: <b style="color:#fff">${c}</b>`).join('<br>');

        wFlag.src = winner.img.src; wName.innerText = winner.name;
        winnerOverlay.style.display = 'flex'; createParticles(WIDTH/2, HEIGHT/2, '#FFD700', 50);
        
        let countdown = 5; timerText.innerText = `NEXT ROUND IN ${countdown}...`;
        const interval = setInterval(() => {
            countdown--; timerText.innerText = `NEXT ROUND IN ${countdown}...`;
            if (countdown <= 0) { clearInterval(interval); resetGame(); }
        }, 1000);
    }

    function resetGame() {
        isGameOver = false; winnerOverlay.style.display = 'none';
        document.body.style.backgroundColor = '#050505';
        roundEl.innerText = roundCount; suddenDeath = false; gameStartTime = performance.now();
        document.body.classList.remove('sudden', 'warning'); bgMusic.volume = 0.3; 
        resize(); 

        balls = []; particles = [];
        COUNTRIES.forEach(c => balls.push(new Ball(c)));
        balls.sort(() => Math.random() - 0.5);
        totalCounter.innerText = COUNTRIES.length;
        animate();
    }

    window.onload = function() { initAudio(); resetGame(); };

</script>
</body>
</html>
