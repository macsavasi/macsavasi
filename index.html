<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ULTRA BATTLE ARENA vFinal - PRO MODE</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">

<style>
/* --- CSS G√úNCELLENDƒ∞ (BOSS MODU KALDIRILDI) --- */
:root { --gs-primary: #A90432; --fb-primary: #002D72; --bjk-primary: #111; --bg-dark: #050505; }
body { margin: 0; background-color: var(--bg-dark); background-image: radial-gradient(circle at 50% 50%, rgba(0,0,0,0), rgba(0,0,0,1)); color: #fff; font-family: 'Montserrat', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; user-select: none; transition: background-color 1s ease; }
body.leader-gs { background-color: #1a0005; } body.leader-fb { background-color: #00051a; } body.leader-bjk { background-color: #111; }
#weather-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; opacity: 0.6; }
.rain { background: url('https://i.imgur.com/7Q3l9M4.png'); animation: rain 0.5s linear infinite; }
.snow { background: url('https://i.imgur.com/8xL1q2p.png'); animation: snow 10s linear infinite; }
.promo-bar { width: 100%; max-width: 600px; height: 30px; background: rgba(0,0,0,0.6); border: 1px solid rgba(255,215,0,0.3); border-radius: 15px; overflow: hidden; margin-bottom: 10px; display: flex; align-items: center; position: relative; box-shadow: 0 0 15px rgba(255, 215, 0, 0.1); }
.promo-content { white-space: nowrap; position: absolute; will-change: transform; animation: promoScroll 20s linear infinite; font-size: 13px; color: #ffd700; font-weight: 700; letter-spacing: 1px; text-shadow: 0 1px 2px #000; }
@keyframes promoScroll { 0% { transform: translateX(100%); left: 100%; } 100% { transform: translateX(-100%); left: 0; } }
#sub-notification-area { position: fixed; top: 150px; right: 20px; width: 250px; height: auto; z-index: 999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
.sub-card { background: linear-gradient(90deg, #aa00aa, #4400cc); color: white; padding: 10px 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 10px; font-family: 'Montserrat', sans-serif; transform: translateX(120%); animation: slideInSub 4s forwards; border: 1px solid rgba(255,255,255,0.3); }
.sub-icon { font-size: 18px; color: #ffd700; animation: bounce 1s infinite; }
.sub-text { display: flex; flex-direction: column; }
.sub-name { font-weight: 800; font-size: 13px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; max-width: 150px; }
.sub-action { font-size: 10px; opacity: 0.8; }
@keyframes slideInSub { 0% { transform: translateX(120%); opacity: 0; } 10% { transform: translateX(0); opacity: 1; } 85% { transform: translateX(0); opacity: 1; } 100% { transform: translateX(120%); opacity: 0; } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
.goal-bar-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 8px; background: rgba(255,255,255,0.1); z-index: 100; }
.goal-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #ffd700, #ffae00); transition: width 0.5s; box-shadow: 0 0 10px #ffd700; }
.goal-text { position: fixed; top: 10px; width: 100%; text-align: center; font-size: 12px; font-weight: bold; letter-spacing: 2px; color: #aaa; z-index: 101; text-shadow: 0 1px 2px #000; }
.central-dashboard { display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 30px; z-index: 10; flex: 0 0 auto; position: relative; }
.round-box { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); padding: 5px 40px; border-radius: 30px; margin-bottom: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 10px; }
.round-label { font-family: 'Montserrat', sans-serif; font-weight: 700; letter-spacing: 2px; font-size: 14px; color: #aaa; }
.round-val { font-family: 'Bebas Neue', sans-serif; font-size: 32px; color: #ffd700; line-height: 1; }
.top-scoreboard { display: flex; gap: 30px; margin-bottom: 5px; background: rgba(0,0,0,0.6); padding: 8px 25px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); }
.score-badge { display: flex; align-items: center; gap: 8px; font-family: 'Bebas Neue'; font-size: 24px; color: #888; transition: 0.3s; }
.score-badge.active { color: #fff; transform: scale(1.1); text-shadow: 0 0 10px currentColor; }
.score-badge span { color: #fff; font-size: 24px; margin-left: 2px; }
.timer-container { text-align: center; z-index: 5; margin-bottom: 10px; position: relative; }
.timer { font-family: 'Bebas Neue', sans-serif; font-size: 90px; line-height: 0.9; background: -webkit-linear-gradient(#fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2)); }
.timer.danger { background: -webkit-linear-gradient(#ff3b3b, #800000); -webkit-background-clip: text; animation: pulse 0.8s infinite; }
.event-x2 { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: radial-gradient(circle, #ff0000, #550000); padding: 10px 25px; border-radius: 15px; border: 2px solid #ffd700; box-shadow: 0 0 30px #ff0000; z-index: 200; pointer-events: none; font-family: 'Bebas Neue'; color: #fff; text-align: center; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.event-x2.active { transform: translate(-50%, -50%) scale(1); animation: shake 0.5s infinite; }
.event-x2 h1 { margin: 0; font-size: 36px; line-height: 1; text-shadow: 2px 2px 0 #000; }
.event-x2 p { margin: 0; font-size: 12px; letter-spacing: 2px; }
.arena { display: flex; justify-content: center; align-items: flex-end; flex-grow: 1; gap: 20px; padding: 0 40px 60px 40px; position: relative; height: 100%; }
.team-col { flex: 1; max-width: 300px; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; position: relative; }
.bar-container { width: 100%; height: 100%; background: rgba(255,255,255,0.02); border-radius: 20px 20px 0 0; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 0 30px rgba(0,0,0,0.3); transition: border-color 0.2s; will-change: transform; }
.tribune { position: absolute; bottom: 0; left: 0; width: 100%; height: 120px; background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Crowd_silhouette.svg/1280px-Crowd_silhouette.svg.png'); background-size: cover; background-position: bottom center; opacity: 0.6; z-index: 6; pointer-events: none; mask-image: linear-gradient(to top, rgba(0,0,0,1), rgba(0,0,0,0)); -webkit-mask-image: linear-gradient(to top, rgba(0,0,0,1), rgba(0,0,0,0)); animation: crowdJump 1s infinite alternate; }
.gs .tribune { filter: drop-shadow(0 0 5px #A90432); } .fb .tribune { filter: drop-shadow(0 0 5px #002D72); } .bjk .tribune { filter: drop-shadow(0 0 5px #fff); }
.is-leader .tribune { opacity: 0.9; animation: crowdJump 0.3s infinite alternate; }
.crown-icon { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); font-size: 50px; color: #ffd700; opacity: 0; z-index: 40; transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); filter: drop-shadow(0 4px 10px rgba(0,0,0,0.8)); }
.is-leader .crown-icon { top: 25px; opacity: 1; animation: floatCrown 3s ease-in-out infinite; }
.bar-fill { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1); min-height: 140px; z-index: 5; }
.bar-fill::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #fff; box-shadow: 0 0 20px #fff; opacity: 0.8; }
.gs .bar-fill { background: linear-gradient(to top, #300000, var(--gs-primary)); box-shadow: 0 0 60px var(--gs-primary); }
.fb .bar-fill { background: linear-gradient(to top, #000030, var(--fb-primary)); box-shadow: 0 0 60px var(--fb-primary); }
.bjk .bar-fill { background: linear-gradient(to top, #111, #444); box-shadow: 0 0 60px rgba(255,255,255,0.2); }
.team-content { position: absolute; bottom: 20px; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 20; text-shadow: 0 2px 10px rgba(0,0,0,0.9); }
.team-logo { width: 90px; height: 90px; object-fit: contain; margin-bottom: 5px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.6)); transition: transform 0.3s; }
.is-leader .team-logo { transform: scale(1.15); }
.vote-count { font-family: 'Bebas Neue'; font-size: 70px; line-height: 0.9; }
.mvp-box { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); padding: 4px 12px; border-radius: 6px; margin-top: 8px; border: 1px solid rgba(255,255,255,0.15); text-align: center; min-width: 100px; opacity: 0; transition: opacity 0.5s; }
.mvp-box.visible { opacity: 1; }
.mvp-title { font-size: 9px; color: #ffd700; letter-spacing: 1px; font-weight: bold; }
.mvp-name { font-size: 13px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
.mvp-score { font-size: 11px; color: #ccc; }
.captain-badge { color: #ffd700; font-size: 10px; margin-right: 3px; display: none; }
.has-captain .captain-badge { display: inline-block; }
.ticker-wrap { position: fixed; bottom: 0; width: 100%; height: 45px; background: #000; border-top: 2px solid #222; display: flex; align-items: center; overflow: hidden; z-index: 50; }
.ticker-head { background: #ffd700; color: #000; padding: 0 20px; height: 100%; display: flex; align-items: center; font-weight: 900; letter-spacing: 1px; box-shadow: 10px 0 20px rgba(0,0,0,0.8); z-index: 2; }
.ticker-move { display: inline-block; white-space: nowrap; padding-left: 100%; animation: ticker 25s linear infinite; }
.t-item { display: inline-flex; align-items: center; margin-right: 40px; font-size: 15px; color: #888; }
.t-item b { color: #fff; margin-right: 5px; font-weight: 700; }
.t-gs { color: #ff4d4d; } .t-fb { color: #4da6ff; } .t-bjk { color: #fff; }
#overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.5s; }
#overlay.active { opacity: 1; pointer-events: all; }
@keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
@keyframes floatCrown { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-5px); } }
@keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px) rotate(-1deg); } 75% { transform: translateX(5px) rotate(1deg); } 100% { transform: translateX(0); } }
@keyframes rain { 0% { background-position: 0 0; } 100% { background-position: 0 1000px; } }
@keyframes snow { 0% { background-position: 0 0; } 100% { background-position: 100px 1000px; } }
@keyframes crowdJump { 0% { transform: translateY(0); } 100% { transform: translateY(-5px); } }
</style>
</head>

<body>

<div id="weather-layer"></div>
<div id="sub-notification-area"></div>
<div class="goal-bar-wrap"><div class="goal-bar-fill" id="goal-bar-fill"></div></div>
<div class="goal-text">HEDEF: 1000 OY</div>

<!-- BOSS CONTAINER TAMAMEN KALDIRILDI -->

<div class="event-x2" id="event-x2"><h1>x2 PUAN!</h1><p>10 SANƒ∞YE BOYUNCA</p></div>

<div class="central-dashboard">
    <div class="promo-bar">
        <div class="promo-content"><i class="fa-solid fa-bullhorn"></i> HO≈û GELDƒ∞Nƒ∞Z! TAKIMLARINIZA OY VEREREK DESTEK OLUN! -- ABONE OLARAK ƒ∞SMƒ∞Nƒ∞Zƒ∞ EKRANA YAZDIRIN! -- KAZANAN TAKIM MAR≈ûINI √áALDIRIR! -- GS YAZ, FB YAZ, BJK YAZ DESTEKLE!</div>
    </div>
    <div class="round-box"><div class="round-label">ROUND</div><div class="round-val" id="round-num">1</div></div>
    <div class="top-scoreboard">
        <div class="score-badge" id="badge-gs"><i class="fa-solid fa-trophy"></i> GS <span id="total-gs">0</span></div>
        <div class="score-badge" id="badge-fb"><i class="fa-solid fa-trophy"></i> FB <span id="total-fb">0</span></div>
        <div class="score-badge" id="badge-bjk"><i class="fa-solid fa-trophy"></i> BJK <span id="total-bjk">0</span></div>
    </div>
    <div class="timer-container"><div id="timer" class="timer">60</div></div>
</div>

<div class="arena">
  <div class="team-col gs" id="col-gs"><div class="bar-container"><i class="fa-solid fa-crown crown-icon"></i><div class="bar-fill" id="bar-gs"></div><div class="tribune"></div><div class="team-content"><img src="https://upload.wikimedia.org/wikipedia/commons/f/f6/Galatasaray_Sports_Club_Logo.png" class="team-logo"><div class="vote-count" id="score-gs">0</div><div class="mvp-box" id="mvp-gs"><div class="mvp-title">MVP</div><div class="mvp-name">-</div><div class="mvp-score">0 Oy</div></div></div></div></div>
  <div class="team-col fb" id="col-fb"><div class="bar-container"><i class="fa-solid fa-crown crown-icon"></i><div class="bar-fill" id="bar-fb"></div><div class="tribune"></div><div class="team-content"><img src="https://upload.wikimedia.org/wikipedia/tr/8/86/Fenerbah%C3%A7e_SK.png" class="team-logo"><div class="vote-count" id="score-fb">0</div><div class="mvp-box" id="mvp-fb"><div class="mvp-title">MVP</div><div class="mvp-name">-</div><div class="mvp-score">0 Oy</div></div></div></div></div>
  <div class="team-col bjk" id="col-bjk"><div class="bar-container"><i class="fa-solid fa-crown crown-icon"></i><div class="bar-fill" id="bar-bjk"></div><div class="tribune"></div><div class="team-content"><img src="https://upload.wikimedia.org/wikipedia/sco/4/47/Besiktas_JK%27s_official_logo.png" class="team-logo"><div class="vote-count" id="score-bjk">0</div><div class="mvp-box" id="mvp-bjk"><div class="mvp-title">MVP</div><div class="mvp-name">-</div><div class="mvp-score">0 Oy</div></div></div></div></div>
</div>

<div class="ticker-wrap">
  <div class="ticker-head">CANLI AKI≈û</div><div class="ticker-move" id="ticker-content"></div>
</div>

<div id="overlay">
  <h1 id="win-title" style="font-family:'Bebas Neue'; font-size:100px; color:#fff; margin:0; text-transform:uppercase;">KAZANAN</h1>
  <img id="win-img" src="" style="width:250px; height:250px; object-fit:contain; margin:30px 0;">
  <div id="win-msg" style="font-size:30px; color:#ccc;">Tebrikler!</div>
  <div id="last-hit-display" style="margin-top:20px; font-size:24px; color:#ff4d4d; font-weight:bold; letter-spacing:1px; background:rgba(0,0,0,0.7); padding:5px 20px; border-radius:10px;"></div>
  <div id="next-timer" style="margin-top:40px; font-size:40px; color:#ffd700; border:2px solid #ffd700; padding:10px 40px; border-radius:50px;">Sonraki: 10</div>
</div>

<canvas id="confetti" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1500;"></canvas>

<!-- ‚úÖ 1. KATMAN: HTML'DE AUDIO ELEMENTLERƒ∞ muted BA≈ûLAT -->
<audio id="sfx-gol" src="gol.mp3" muted></audio> 
<audio id="anthem-gs" src="mars_gs.mp3" loop muted></audio>
<audio id="anthem-fb" src="mars_fb.mp3" loop muted></audio>
<audio id="anthem-bjk" src="mars_bjk.mp3" loop muted></audio>
<audio id="ambience" src="stadium.mp3" loop muted></audio>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
// --- CONFIGURATION ---
const urlParams = new URLSearchParams(window.location.search);

// ARTIK SADECE S√úRE VE SES AYARI KALDI - API KEY GEREKMEZ
let CONFIG = {
  duration: parseInt(urlParams.get('time')) || 60,
  muted: false
};

// --- STATE MANAGEMENT ---
let STATE = {
  active: false,
  round: 1,
  time: CONFIG.duration,
  votes: { gs: 0, fb: 0, bjk: 0 },
  wins: { gs: 0, fb: 0, bjk: 0 },
  mvp: { 
    gs: { user: '-', score: 0, data: {} },
    fb: { user: '-', score: 0, data: {} },
    bjk: { user: '-', score: 0, data: {} }
  },
  totalGameVotes: 0,
  lastHitter: null,
  isDoublePoints: false,
  doublePointTriggerTime: -1,
  currentLeader: null,
  
  // ‚è±Ô∏è KULLANICI ‚Üí SON OY ZAMANI
  lastVoteTime: {}
};

// --- DOM ELEMENTS ---
const UI = {
  timer: document.getElementById('timer'),
  scores: { gs: document.getElementById('score-gs'), fb: document.getElementById('score-fb'), bjk: document.getElementById('score-bjk') },
  bars: { gs: document.getElementById('bar-gs'), fb: document.getElementById('bar-fb'), bjk: document.getElementById('bar-bjk') },
  cols: { gs: document.getElementById('col-gs'), fb: document.getElementById('col-fb'), bjk: document.getElementById('col-bjk') },
  badges: { gs: document.getElementById('badge-gs'), fb: document.getElementById('badge-fb'), bjk: document.getElementById('badge-bjk') },
  total: { gs: document.getElementById('total-gs'), fb: document.getElementById('total-fb'), bjk: document.getElementById('total-bjk') },
  mvp: {
    gs: { name: document.querySelector('#mvp-gs .mvp-name'), score: document.querySelector('#mvp-gs .mvp-score'), box: document.getElementById('mvp-gs') },
    fb: { name: document.querySelector('#mvp-fb .mvp-name'), score: document.querySelector('#mvp-fb .mvp-score'), box: document.getElementById('mvp-fb') },
    bjk: { name: document.querySelector('#mvp-bjk .mvp-name'), score: document.querySelector('#mvp-bjk .mvp-score'), box: document.getElementById('mvp-bjk') }
  },
  audio: { 
      gol: document.getElementById('sfx-gol'),
      amb: document.getElementById('ambience'),
      gs: document.getElementById('anthem-gs'),
      fb: document.getElementById('anthem-fb'),
      bjk: document.getElementById('anthem-bjk')
  },
  goalBar: document.getElementById('goal-bar-fill'),
  x2Event: document.getElementById('event-x2'),
  lastHitDisplay: document.getElementById('last-hit-display'),
  weather: document.getElementById('weather-layer'),
  subArea: document.getElementById('sub-notification-area')
};

// --- HELPERS ---
function notifySubscriber(name) {
    const card = document.createElement('div');
    card.className = 'sub-card';
    card.innerHTML = `<i class="fa-solid fa-bell sub-icon"></i><div class="sub-text"><span class="sub-name">${name}</span><span class="sub-action">ABONE OLDU!</span></div>`;
    UI.subArea.appendChild(card);
    setTimeout(() => { card.remove(); }, 4000);
}

window.toggleTestMode = function() {
  console.log("Test modu a√ßƒ±ldƒ±. Botlar oy veriyor...");
  setInterval(() => {
    if(!STATE.active) return;
    let teams = ['gs','fb','bjk'];
    let users = ['Barƒ±≈ü','Ahmet','Mehmet','Ay≈üe','Fatma','StreamLover','ProOyuncu','Kral123'];
    let mult = Math.random() > 0.9 ? 5 : 1; 
    processVote(teams[Math.floor(Math.random()*3)], users[Math.floor(Math.random()*users.length)], mult);
  }, 200);
}

// ‚úÖ 3. KATMAN: SES Kƒ∞Lƒ∞Dƒ∞Nƒ∞ A√áMA FONKSƒ∞YONU
function unlockAudioKillSwitch() {
  if (CONFIG.muted) return;
  
  // T√ºm sesleri topla
  const allAudios = [
    UI.audio.amb,
    UI.audio.gs,
    UI.audio.fb,
    UI.audio.bjk,
    UI.audio.gol
  ];
  
  // Her ses i√ßin: muted true -> play -> muted false
  allAudios.forEach(audio => {
    // Eƒüer audio element yoksa veya zaten playing ise ge√ß
    if (!audio || !audio.paused) return;
    
    // muted true yap ve sessizce oynatmaya √ßalƒ±≈ü
    audio.muted = true;
    
    // Volume ayarla (sessiz oynatƒ±lƒ±rken)
    if (audio.id === 'ambience') audio.volume = 0;
    else audio.volume = 0;
    
    // Play promise
    const playPromise = audio.play();
    
    if (playPromise !== undefined) {
      playPromise.then(() => {
        // ‚úÖ Ba≈üarƒ±lƒ±: unmute yap ve volume ayarla
        audio.muted = false;
        if (audio.id === 'ambience') audio.volume = 0.3;
        else if (audio.id === 'sfx-gol') audio.volume = 0.7;
        else audio.volume = 0.5;
        
        console.log(`‚úÖ Audio unlocked: ${audio.id}`);
      }).catch(err => {
        // ‚ùå Ba≈üarƒ±sƒ±z: tekrar dene
        console.log(`‚ö†Ô∏è First try failed for ${audio.id}:`, err);
        setTimeout(() => {
          audio.muted = true;
          audio.play().then(() => {
            audio.muted = false;
            if (audio.id === 'ambience') audio.volume = 0.3;
            else if (audio.id === 'sfx-gol') audio.volume = 0.7;
            else audio.volume = 0.5;
            console.log(`‚úÖ Audio unlocked on retry: ${audio.id}`);
          }).catch(e => {
            console.log(`‚ùå Final fail for ${audio.id}:`, e);
          });
        }, 1000);
      });
    }
  });
}

// G√ºncellenmi≈ü safePlay fonksiyonu
async function safePlay(audioElem) {
    try { 
        if(audioElem.readyState >= 2) {
            await audioElem.play(); 
            console.log(`üîä Playing: ${audioElem.id}`);
        }
    } catch(err) { 
        console.log("‚ùå Auto-play blocked for:", audioElem.id, err); 
    }
}

// --- GAME LOGIC ---
let timerInterval;

function initGame() {
  // ‚úÖ 2. KATMAN: SES Kƒ∞Lƒ∞Dƒ∞Nƒ∞ A√á (EN KRƒ∞Tƒ∞K ADIM!)
  unlockAudioKillSwitch();
  
  // Ses seviyelerini ayarla (unlockAudioKillSwitch i√ßinde de ayarlanƒ±yor ama yine de)
  UI.audio.amb.volume = 0.3; 
  UI.audio.gs.volume = 0.5; 
  UI.audio.fb.volume = 0.5; 
  UI.audio.bjk.volume = 0.5;
  UI.audio.gol.volume = 0.7;
  
  resetRound();
  
  // ‚úÖ FIX 1: pollChat ARTIK OYUN BA≈ûLADIKTAN SONRA √áAƒûRILIYOR
  pollChat();

  // Body click listener artƒ±k GEREKSƒ∞Z ama yine de ekleyelim
  document.body.addEventListener('click', () => { 
      if(!CONFIG.muted) {
          console.log("üñ±Ô∏è User clicked, playing ambience");
          safePlay(UI.audio.amb); 
      }
  }, {once:true});
}

function resetRound() {
  clearInterval(timerInterval);
  STATE.active = true;
  STATE.time = CONFIG.duration;
  STATE.votes = { gs:0, fb:0, bjk:0 };
  STATE.lastHitter = null;
  STATE.currentLeader = null;
  
  STATE.doublePointTriggerTime = -1;
  if(CONFIG.duration > 30) STATE.doublePointTriggerTime = Math.floor(Math.random() * (CONFIG.duration - 20)) + 10;
  
  ['gs','fb','bjk'].forEach(k => {
    STATE.mvp[k] = { user: '-', score: 0, data: {} };
    UI.mvp[k].box.classList.remove('visible'); UI.mvp[k].box.classList.remove('has-captain');
    // Sadece pause yap, currentTime'ƒ± sƒ±fƒ±rlama (√ß√ºnk√º artƒ±k loop'lar)
    UI.audio[k].pause();
  });

  // üîÅ yeni tur ‚Üí herkes sƒ±fƒ±rdan
  STATE.lastVoteTime = {};

  document.getElementById('overlay').classList.remove('active');
  UI.timer.classList.remove('danger');
  
  // Ambience'ƒ± otomatik oynat (eƒüer muted deƒüilse)
  if(!CONFIG.muted) {
      setTimeout(() => {
          if (UI.audio.amb.paused) {
              safePlay(UI.audio.amb);
          }
      }, 500);
  }
  
  updateDisplay();
  
  timerInterval = setInterval(() => {
    STATE.time--;
    UI.timer.innerText = STATE.time;
    if(STATE.time === STATE.doublePointTriggerTime) {
        STATE.isDoublePoints = true; UI.x2Event.classList.add('active');
        setTimeout(() => { STATE.isDoublePoints = false; UI.x2Event.classList.remove('active'); }, 10000);
    }
    if(STATE.time <= 10) UI.timer.classList.add('danger');
    if(STATE.time <= 0) endRound();
  }, 1000);
}

function processVote(team, user, multiplier = 1) {
  if (!STATE.active) return;

  const now = Date.now();
  const last = STATE.lastVoteTime[user] || 0;

  // ‚õî 3 saniye dolmadƒ±ysa sayma
  if (now - last < 3000) return;

  // ‚úÖ oy kabul edildi ‚Üí zamanƒ± kaydet
  STATE.lastVoteTime[user] = now;

  let points = (STATE.isDoublePoints ? 2 : 1) * multiplier;
  STATE.votes[team] += points;
  STATE.totalGameVotes += points;
  
  let goalPercent = Math.min((STATE.totalGameVotes / 1000) * 100, 100);
  UI.goalBar.style.width = goalPercent + "%";
  
  if(user) {
      STATE.lastHitter = user;
      if(!STATE.mvp[team].data[user]) STATE.mvp[team].data[user] = 0;
      STATE.mvp[team].data[user] += points;
      if(STATE.mvp[team].data[user] > STATE.mvp[team].score) {
        STATE.mvp[team].score = STATE.mvp[team].data[user]; STATE.mvp[team].user = user;
      }
      addTicker(user, team, points);
  }
  updateDisplay();
}

function updateDisplay() {
  UI.scores.gs.innerText = STATE.votes.gs; UI.scores.fb.innerText = STATE.votes.fb; UI.scores.bjk.innerText = STATE.votes.bjk;
  let max = Math.max(STATE.votes.gs, STATE.votes.fb, STATE.votes.bjk, 1);
  let leader = null, leaderScore = -1;
  ['gs', 'fb', 'bjk'].forEach(t => { if(STATE.votes[t] > leaderScore) leaderScore = STATE.votes[t]; });
  let leaders = ['gs', 'fb', 'bjk'].filter(t => STATE.votes[t] === leaderScore && leaderScore > 0);
  if(leaders.length === 1) leader = leaders[0];

  if(leader !== STATE.currentLeader) {
      STATE.currentLeader = leader;
      ['gs', 'fb', 'bjk'].forEach(team => { 
          if(team !== leader) {
              UI.audio[team].pause(); 
              console.log(`‚è∏Ô∏è Paused: ${team} anthem`);
          }
      });
      if(leader && !CONFIG.muted) {
          console.log(`‚ñ∂Ô∏è Playing leader anthem: ${leader}`);
          safePlay(UI.audio[leader]);
      }
  }

  ['gs', 'fb', 'bjk'].forEach(t => {
    UI.bars[t].style.height = (STATE.votes[t] / max * 100) + "%";
    UI.cols[t].classList.remove('is-leader'); UI.badges[t].classList.remove('active');
    if(t === leader) { UI.cols[t].classList.add('is-leader'); UI.badges[t].classList.add('active'); }
    if(STATE.mvp[t].score > 0) {
      UI.mvp[t].name.innerHTML = `<i class="fa-solid fa-star captain-badge"></i>` + STATE.mvp[t].user;
      UI.mvp[t].score.innerText = STATE.mvp[t].score + " OY";
      UI.mvp[t].box.classList.add('visible'); UI.mvp[t].box.classList.add('has-captain');
    }
  });
  document.body.className = leader ? `leader-${leader}` : '';
}

function addTicker(user, team, points) {
  const el = document.createElement('div'); el.className = 't-item';
  let colorClass = team === 'gs' ? 't-gs' : (team === 'fb' ? 't-fb' : 't-bjk');
  let ptText = points > 1 ? `+${points}` : `+${points}`;
  if(points >= 5) ptText += " üî•"; 
  el.innerHTML = `<b>${user}</b> <span class="${colorClass}">${team.toUpperCase()} ${ptText}</span>`;
  document.getElementById('ticker-content').prepend(el);
  if(document.getElementById('ticker-content').children.length > 20) document.getElementById('ticker-content').lastChild.remove();
}

function endRound() {
  clearInterval(timerInterval);
  STATE.active = false;
  if(!CONFIG.muted) { 
      UI.audio.amb.pause(); 
      UI.audio.gs.pause(); 
      UI.audio.fb.pause(); 
      UI.audio.bjk.pause(); 
      console.log("‚è∏Ô∏è All anthems paused at round end");
  }

  let max = Math.max(STATE.votes.gs, STATE.votes.fb, STATE.votes.bjk);
  let winners = Object.keys(STATE.votes).filter(k => STATE.votes[k] === max && max > 0);
  
  let ov = document.getElementById('overlay'), title = document.getElementById('win-title'), img = document.getElementById('win-img'), msg = document.getElementById('win-msg'), lastHit = document.getElementById('last-hit-display');
  ov.classList.add('active');
  lastHit.innerHTML = STATE.lastHitter ? `<i class="fa-solid fa-crosshairs"></i> SON VURU≈û: ${STATE.lastHitter}` : "";

  if(winners.length === 1) {
    let w = winners[0]; STATE.wins[w]++; UI.total[w].innerText = STATE.wins[w];
    if(!CONFIG.muted) {
        console.log(`üéâ Winner ${w}! Playing goal sound`);
        safePlay(UI.audio.gol);
    }
    title.innerText = w.toUpperCase() + " KAZANDI!";
    title.style.color = w==='gs'?'#A90432':(w==='fb'?'#002D72':'#fff');
    if(w==='gs') img.src = "https://upload.wikimedia.org/wikipedia/commons/f/f6/Galatasaray_Sports_Club_Logo.png";
    if(w==='fb') img.src = "https://upload.wikimedia.org/wikipedia/tr/8/86/Fenerbah%C3%A7e_SK.png";
    if(w==='bjk') img.src = "https://upload.wikimedia.org/wikipedia/sco/4/47/Besiktas_JK%27s_official_logo.png";
    img.style.display = 'block';
    confetti({ particleCount: 300, spread: 120, origin: { y: 0.6 } });
    msg.innerText = "MVP: " + STATE.mvp[w].user;
  } else {
    title.innerText = "BERABERLƒ∞K!"; title.style.color = "#fff"; img.style.display = 'none'; msg.innerText = "Kazanan √ßƒ±kmadƒ±.";
  }

  let next = 10;
  let nextInt = setInterval(() => {
    document.getElementById('next-timer').innerText = "Sonraki: " + (--next);
    if(next < 0) { 
        clearInterval(nextInt); 
        STATE.round++; 
        document.getElementById('round-num').innerText = STATE.round; 
        resetRound(); 
    }
  }, 1000);
}

// --- NEW CHAT READER (VIA WORKER) ---
const WORKER_URL = "https://yt-chat-proxy.dumbmuzik.workers.dev/chat";

// üîí AYNI MESAJLARI TEKRAR ƒ∞≈ûLEMEMEK ƒ∞√áƒ∞N
let seen = new Set();

async function pollChat() {
  try {
    const res = await fetch(WORKER_URL);
    const data = await res.json();

    if (!data.live) {
      setTimeout(pollChat, 5000);
      return;
    }

    // ‚úÖ FIX 2: BELLEK KORUMASI
    if (seen.size > 1000) {
      seen.clear();
    }

    data.messages.forEach(msg => {
      const key = msg.user + "|" + msg.text;

      // üîí Aynƒ± mesajƒ± bir daha i≈üleme
      if (seen.has(key)) return;
      seen.add(key);

      // ‚úÖ FIX 3: REGEX KONTROL√ú (Ba≈ülangƒ±√ß e≈üle≈ümesi + Lowercase)
      const text = msg.text.toLowerCase();

      if (/^gs\b/.test(text)) processVote("gs", msg.user);
      else if (/^fb\b/.test(text)) processVote("fb", msg.user);
      else if (/^bjk\b/.test(text)) processVote("bjk", msg.user);
    });

    setTimeout(pollChat, data.poll || 3000);

  } catch (e) {
    console.error("Chat proxy error", e);
    setTimeout(pollChat, 7000);
  }
}

window.onload = initGame;
</script>
</body>
</html>
