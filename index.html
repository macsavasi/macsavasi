<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Flag Battle Royale</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto:wght@900&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0; overflow: hidden; background-color: #050505;
            font-family: 'Roboto', sans-serif; touch-action: none; user-select: none;
        }

        /* Arka Plan */
        #bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 90%);
            z-index: -1;
        }

        canvas { display: block; width: 100vw; height: 100vh; }

        /* UI */
        .hook-text {
            position: absolute; width: 100%; text-align: center;
            text-transform: uppercase; color: #fff; pointer-events: none; z-index: 10;
            text-shadow: 0 0 15px rgba(0,0,0,0.8);
        }

        .top-hook {
            top: 8%; font-family: 'Black Ops One', cursive; font-size: 2.8rem;
            color: #00ffff; letter-spacing: 2px;
            text-shadow: 0 0 20px #00ffff;
            animation: pulse 2s infinite;
        }

        .bottom-hook {
            bottom: 12%; font-size: 1.2rem; font-weight: 900;
            background: linear-gradient(90deg, transparent, rgba(255, 0, 85, 0.8), transparent);
            padding: 8px 0; color: #fff; letter-spacing: 1px;
        }

        /* Kazanan Ekranƒ± */
        #winnerOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.9); z-index: 20;
        }

        #w-flag {
            width: 180px; height: 180px; border-radius: 50%;
            border: 8px solid #FFD700; box-shadow: 0 0 80px #FFD700;
            object-fit: cover; margin-bottom: 20px; animation: spin 10s linear infinite;
        }

        #w-title { font-family: 'Black Ops One'; font-size: 3.5rem; color: #FFD700; margin: 0; }
        #w-name { font-size: 2rem; color: #fff; text-transform: uppercase; font-weight: bold; margin-top: 10px; }
        #timer { margin-top: 30px; font-size: 1.5rem; color: #888; }

        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.02);} 100% {transform: scale(1);} }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="bg"></div>
    
    <div class="hook-text top-hook">FLAG BATTLE<br>ROYALE</div>
    <div class="hook-text bottom-hook">LAST ONE STANDING WINS! üèÜ</div>

    <div id="winnerOverlay">
        <div id="w-title">WINNER</div>
        <img id="w-flag" src="" alt="">
        <div id="w-name">COUNTRY</div>
        <div id="timer">NEXT ROUND SOON...</div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const winnerOverlay = document.getElementById('winnerOverlay');
    const wFlag = document.getElementById('w-flag');
    const wName = document.getElementById('w-name');
    const timerText = document.getElementById('timer');

    // --- SES MOTORU ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;

    function initAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
        // Tarayƒ±cƒ± izin verirse resume et, vermezse ilk tƒ±klamada a√ßƒ±lacak
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    // Ses kilidini a√ßmak i√ßin ekrana herhangi bir dokunu≈üu dinle
    document.addEventListener('click', () => {
        if (audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }, { once: true });
    
    document.addEventListener('touchstart', () => {
        if (audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }, { once: true });

    function playSound(type) {
        if (!audioCtx) return;
        // Eƒüer ses context'i hala suspended ise (kullanƒ±cƒ± hi√ß etkile≈üime girmediyse) ses √ßalma
        if (audioCtx.state === 'suspended') return;

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;
        
        if (type === 'bounce') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } else if (type === 'eliminate') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(300, now);
            osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        }
    }

    // --- AYARLAR ---
    let WIDTH, HEIGHT, CX, CY, ARENA_RADIUS;
    
    function resize() {
        WIDTH = window.innerWidth;
        HEIGHT = window.innerHeight;
        canvas.width = WIDTH;
        canvas.height = HEIGHT;
        
        CX = WIDTH / 2;
        CY = HEIGHT * 0.38; 
        ARENA_RADIUS = (Math.min(WIDTH, HEIGHT) / 2) * 0.72;
    }
    resize();
    window.addEventListener('resize', resize);

    // Fƒ∞Zƒ∞K AYARLARI
    const BALL_RADIUS = 13;
    const ROTATION_SPEED = 0.025; 
    const GAP_SIZE = Math.PI / 4.5; 
    const GRAVITY = 0.25; 
    const FRICTION_ARENA = 1.0; 
    const FRICTION_AIR = 0.98;

    let arenaRotation = 0;
    let screenShake = 0;

    // √úlke Listesi
    const COUNTRIES = [
        {c:'tr',n:'Turkey'}, {c:'us',n:'USA'}, {c:'de',n:'Germany'}, {c:'br',n:'Brazil'}, {c:'fr',n:'France'},
        {c:'gb',n:'UK'}, {c:'it',n:'Italy'}, {c:'ru',n:'Russia'}, {c:'cn',n:'China'}, {c:'jp',n:'Japan'},
        {c:'kr',n:'S. Korea'}, {c:'in',n:'India'}, {c:'ca',n:'Canada'}, {c:'au',n:'Australia'}, {c:'es',n:'Spain'},
        {c:'mx',n:'Mexico'}, {c:'id',n:'Indonesia'}, {c:'sa',n:'Saudi Arabia'}, {c:'ar',n:'Argentina'},
        {c:'ng',n:'Nigeria'}, {c:'eg',n:'Egypt'}, {c:'pk',n:'Pakistan'}, {c:'vn',n:'Vietnam'},
        {c:'ph',n:'Philippines'}, {c:'th',n:'Thailand'}, {c:'ir',n:'Iran'}, {c:'nl',n:'Netherlands'}, {c:'pl',n:'Poland'},
        {c:'ua',n:'Ukraine'}, {c:'co',n:'Colombia'}, {c:'se',n:'Sweden'}, {c:'az',n:'Azerbaijan'}, {c:'pt',n:'Portugal'},
        {c:'gr',n:'Greece'}, {c:'be',n:'Belgium'}, {c:'ch',n:'Switzerland'}, {c:'at',n:'Austria'}, {c:'hu',n:'Hungary'},
        {c:'no',n:'Norway'}, {c:'dk',n:'Denmark'}, {c:'fi',n:'Finland'}, {c:'ie',n:'Ireland'}, {c:'nz',n:'New Zealand'},
        {c:'sg',n:'Singapore'}, {c:'my',n:'Malaysia'}, {c:'cl',n:'Chile'}, {c:'pe',n:'Peru'}, {c:'ve',n:'Venezuela'},
        {c:'ec',n:'Ecuador'}, {c:'ma',n:'Morocco'}, {c:'dz',n:'Algeria'}, {c:'kz',n:'Kazakhstan'}, {c:'il',n:'Israel'},
        {c:'qa',n:'Qatar'}, {c:'ae',n:'UAE'}, {c:'hr',n:'Croatia'}, {c:'rs',n:'Serbia'}, {c:'ba',n:'Bosnia'}
    ];

    let balls = [];
    let particles = [];
    let animationId;
    let isGameOver = false;
    let gameRunning = true; // Otomatik ba≈ülangƒ±√ß i√ßin true yapƒ±ldƒ±

    // Partik√ºl
    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.size = Math.random() * 3 + 1;
            this.vx = (Math.random() - 0.5) * 6;
            this.vy = (Math.random() - 0.5) * 6;
            this.life = 1.0; 
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.vy += 0.1; 
            this.life -= 0.02;
        }
        draw(ctx) {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    class Ball {
        constructor(data) {
            this.code = data.c;
            this.name = data.n;
            this.r = BALL_RADIUS;
            
            const angle = Math.random() * Math.PI * 2;
            const dist = Math.random() * (ARENA_RADIUS * 0.6);
            this.x = CX + Math.cos(angle) * dist;
            this.y = CY + Math.sin(angle) * dist;

            this.vx = (Math.random() - 0.5) * 12;
            this.vy = (Math.random() - 0.5) * 12;

            this.img = new Image();
            this.img.src = `https://flagcdn.com/w80/${this.code}.png`;
            
            this.state = 'ARENA'; 
            this.rotation = 0;
            this.rotSpeed = (Math.random() - 0.5) * 0.2;
        }

        update() {
            if(this.state !== 'GROUNDED') this.rotation += this.rotSpeed;

            if (this.state === 'ARENA') {
                this.x += this.vx;
                this.y += this.vy;
                
                this.vx *= FRICTION_ARENA;
                this.vy *= FRICTION_ARENA;

                const currentSpeed = Math.hypot(this.vx, this.vy);
                if(currentSpeed < 2) {
                    this.vx *= 1.1;
                    this.vy *= 1.1;
                }
                if(currentSpeed > 15) {
                    this.vx *= 0.95;
                    this.vy *= 0.95;
                }

                const dist = Math.hypot(this.x - CX, this.y - CY);
                
                if (dist + this.r >= ARENA_RADIUS) {
                    let angle = Math.atan2(this.y - CY, this.x - CX);
                    if (angle < 0) angle += Math.PI * 2;

                    let gapStart = (arenaRotation % (Math.PI * 2));
                    let gapEnd = (gapStart + GAP_SIZE) % (Math.PI * 2);

                    let inGap = false;
                    if (gapStart < gapEnd) {
                        if (angle >= gapStart && angle <= gapEnd) inGap = true;
                    } else {
                        if (angle >= gapStart || angle <= gapEnd) inGap = true;
                    }

                    if (inGap) {
                        this.state = 'FALLING';
                        screenShake = 5;
                        playSound('eliminate');
                        createParticles(this.x, this.y, '#fff', 5);
                    } else {
                        const overlap = dist + this.r - ARENA_RADIUS;
                        const nx = (this.x - CX) / dist;
                        const ny = (this.y - CY) / dist;
                        this.x -= nx * overlap;
                        this.y -= ny * overlap;

                        const dot = this.vx * nx + this.vy * ny;
                        this.vx = this.vx - 2 * dot * nx;
                        this.vy = this.vy - 2 * dot * ny;
                        
                        this.vx *= 1.0; 
                        this.vy *= 1.0;

                        playSound('bounce');
                    }
                }
            } 
            else if (this.state === 'FALLING') {
                this.vy += GRAVITY;
                this.vx *= FRICTION_AIR;
                this.x += this.vx;
                this.y += this.vy;

                if (this.x - this.r < 0 || this.x + this.r > WIDTH) {
                    this.vx *= -0.7;
                    this.x = Math.max(this.r, Math.min(WIDTH - this.r, this.x));
                }

                if (this.y + this.r >= HEIGHT - 10) {
                    this.y = HEIGHT - 10 - this.r;
                    this.vy *= -0.5;
                    this.vx *= 0.9;
                    
                    if(Math.abs(this.vy) < 1 && Math.abs(this.vx) < 0.5) {
                        this.state = 'GROUNDED';
                        createParticles(this.x, this.y + this.r, '#aaa', 3);
                    }
                }
            }
            else if (this.state === 'GROUNDED') {
                this.vx *= 0.9;
                this.vy += GRAVITY;
                this.x += this.vx;
                this.y += this.vy;

                if (this.y + this.r >= HEIGHT - 10) {
                    this.y = HEIGHT - 10 - this.r;
                    this.vy = 0;
                }
                if (this.x - this.r < 0) this.x = this.r;
                if (this.x + this.r > WIDTH) this.x = WIDTH - this.r;
            }
        }

        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);
            
            ctx.beginPath();
            ctx.arc(0, 0, this.r, 0, Math.PI * 2);
            ctx.clip();
            ctx.drawImage(this.img, -this.r, -this.r, this.r*2, this.r*2);
            ctx.restore();

            ctx.beginPath();
            ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
            ctx.strokeStyle = this.state === 'ARENA' ? '#fff' : '#ff0055';
            ctx.lineWidth = 2;
            ctx.stroke();

            if(this.state === 'ARENA') {
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#fff';
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
        }
    }

    function createParticles(x, y, color, count) {
        for(let i=0; i<count; i++) {
            particles.push(new Particle(x, y, color));
        }
    }

    function resolveCollisions() {
        for (let i = 0; i < balls.length; i++) {
            for (let j = i + 1; j < balls.length; j++) {
                let b1 = balls[i];
                let b2 = balls[j];

                let dx = b2.x - b1.x;
                let dy = b2.y - b1.y;
                let dist = Math.hypot(dx, dy);

                if (dist < b1.r + b2.r) {
                    let overlap = (b1.r + b2.r - dist) / 2;
                    let nx = dx / dist;
                    let ny = dy / dist;

                    b1.x -= nx * overlap;
                    b1.y -= ny * overlap;
                    b2.x += nx * overlap;
                    b2.y += ny * overlap;

                    let relativeVx = b2.vx - b1.vx;
                    let relativeVy = b2.vy - b1.vy;
                    let velNormal = relativeVx * nx + relativeVy * ny;

                    if (velNormal > 0) continue;

                    let restitution = 1.0; 
                    let impulse = -(1 + restitution) * velNormal;
                    impulse /= 2; 

                    let ix = impulse * nx;
                    let iy = impulse * ny;

                    let damping = (b1.state === 'ARENA' && b2.state === 'ARENA') ? 1.0 : 0.8;

                    b1.vx -= ix * damping;
                    b1.vy -= iy * damping;
                    b2.vx += ix * damping;
                    b2.vy += iy * damping;
                    
                    if (Math.abs(velNormal) > 10 && b1.state === 'ARENA') {
                         createParticles((b1.x+b2.x)/2, (b1.y+b2.y)/2, '#ffff00', 2);
                         playSound('bounce');
                    }
                }
            }
        }
    }

    function drawArena() {
        arenaRotation += ROTATION_SPEED;
        
        ctx.shadowBlur = 20;
        ctx.shadowColor = '#00ffff';
        ctx.strokeStyle = '#00ffff';
        ctx.lineWidth = 12;
        ctx.lineCap = 'round';

        ctx.beginPath();
        ctx.arc(CX, CY, ARENA_RADIUS, arenaRotation + GAP_SIZE, arenaRotation + Math.PI*2);
        ctx.stroke();
        
        ctx.shadowBlur = 0; 

        ctx.strokeStyle = 'rgba(255, 0, 50, 0.4)';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.arc(CX, CY, ARENA_RADIUS, arenaRotation, arenaRotation + GAP_SIZE);
        ctx.stroke();
    }

    function animate() {
        if (!gameRunning) return;

        ctx.save();
        if (screenShake > 0) {
            let dx = (Math.random() - 0.5) * screenShake;
            let dy = (Math.random() - 0.5) * screenShake;
            ctx.translate(dx, dy);
            screenShake *= 0.9; 
            if(screenShake < 0.5) screenShake = 0;
        }

        ctx.clearRect(0, 0, WIDTH, HEIGHT); 

        drawArena();

        let activeCount = 0;
        let survivor = null;

        balls.forEach(ball => {
            ball.update();
            ball.draw();
            if (ball.state === 'ARENA') {
                activeCount++;
                survivor = ball;
            }
        });
        
        for(let i = particles.length-1; i>=0; i--) {
            particles[i].update();
            particles[i].draw(ctx);
            if(particles[i].life <= 0) particles.splice(i, 1);
        }

        resolveCollisions();
        
        ctx.restore(); 

        if (activeCount <= 1 && survivor && !isGameOver) {
            endGame(survivor);
        } else if (activeCount === 0 && !isGameOver) {
            resetGame();
        } else {
            animationId = requestAnimationFrame(animate);
        }
    }

    function endGame(winner) {
        isGameOver = true;
        cancelAnimationFrame(animationId);
        
        wFlag.src = winner.img.src;
        wName.innerText = winner.name;
        winnerOverlay.style.display = 'flex';
        
        createParticles(WIDTH/2, HEIGHT/2, '#FFD700', 50);
        
        let countdown = 5;
        timerText.innerText = `NEXT ROUND IN ${countdown}...`;
        
        const interval = setInterval(() => {
            countdown--;
            timerText.innerText = `NEXT ROUND IN ${countdown}...`;
            if (countdown <= 0) {
                clearInterval(interval);
                resetGame();
            }
        }, 1000);
    }

    function resetGame() {
        isGameOver = false;
        winnerOverlay.style.display = 'none';
        balls = [];
        particles = [];
        COUNTRIES.forEach(c => balls.push(new Ball(c)));
        balls.sort(() => Math.random() - 0.5);
        animate();
    }

    // SAYFA Y√úKLENƒ∞NCE OYUNU BA≈ûLAT
    window.onload = function() {
        initAudio(); // Ses motorunu kur (tarayƒ±cƒ± izin verirse √ßalƒ±≈üƒ±r)
        resetGame(); // G√∂rsel oyunu ba≈ülat
    };

</script>
</body>
</html>
